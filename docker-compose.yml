services:
    client:
        build: ./src/client
        container_name: chat-client
        ports:
            - "3000:3000"
        depends_on:
            - server
        environment:
            - NEXT_PUBLIC_API_URL=http://server:4000/api
            - CORS_ORIGIN=${CORS_ORIGIN}

    server:
        build: ./src/server
        container_name: chat-server
        depends_on:
            - mongo
            - cassandra
            - postgres
        ports:
            - "4000:4000"
        environment:
            - JWT_SECRET=${JWT_SECRET}
            - CORS_ORIGIN=${CORS_ORIGIN}
            - SERVER_HOST=${SERVER_HOST}
            - SERVER_PORT=${SERVER_PORT}
            - SERVER_PROFILE=${SERVER_PROFILE}
            - POSTGRES_HOST=${POSTGRES_HOST}
            - POSTGRES_PORT=${POSTGRES_PORT}
            - POSTGRES_DB=${POSTGRES_DB}
            - POSTGRES_USER=${POSTGRES_USER}
            - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
            - MONGODB_USER=${MONGODB_USER}
            - MONGODB_PASSWORD=${MONGODB_PASSWORD}
            - MONGODB_DB=${MONGODB_DB}
            - MONGODB_URI=${MONGODB_URI}
            - REDIS_HOST=${REDIS_HOST}
            - REDIS_PORT=${REDIS_PORT}
            - REDIS_PASSWORD=${REDIS_PASSWORD}
            - CASSANDRA_HOST=${CASSANDRA_HOST}
            - CASSANDRA_PORT=${CASSANDRA_PORT}

    mongo:
        image: mongo:latest
        container_name: chat-mongo
        ports:
            - "27017:27017"
        environment:
            MONGO_INITDB_ROOT_USERNAME: ${MONGODB_USER}
            MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_PASSWORD}
            MONGO_INITDB_DATABASE: ${MONGODB_DB}
        volumes:
            - mongo-data:/data/db

    cassandra:
        image: cassandra:latest
        container_name: chat-cassandra
        ports:
            - "9042:9042"
        environment:
            CASSANDRA_CLUSTER_NAME: "chat-cluster"
            CASSANDRA_DC: "datacenter1"
            CASSANDRA_ENDPOINT_SNITCH: "GossipingPropertyFileSnitch"
        volumes:
            - cassandra-data:/var/lib/cassandra
        healthcheck:
            test: ["CMD", "cqlsh", "-e", "describe cluster"]
            interval: 10s
            timeout: 10s
            retries: 10
            start_period: 40s

    cassandra-init:
        image: cassandra:latest
        container_name: chat-cassandra-init
        depends_on:
            cassandra:
                condition: service_healthy
        volumes:
            - ./sql/cassandra/:/cql/
        entrypoint: ["/bin/bash", "-c"]
        command:
            - |
                for file in /cql/*.cql; do
                  echo "Executing $$file";
                  cqlsh cassandra -f "$$file";
                done

    postgres:
        image: postgres:latest
        container_name: chat-postgres
        environment:
            POSTGRES_USER: ${POSTGRES_USER}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
            POSTGRES_DB: ${POSTGRES_DB}
        ports:
            - "${POSTGRES_PORT}:5432"
        volumes:
            - postgres-data:/var/lib/postgresql
            - ./sql/pg/:/docker-entrypoint-initdb.d/

    redis:
        image: redis:latest
        container_name: chat-redis
        ports:
            - "6379:6379"
        command: ["redis-server", "--requirepass", "${REDIS_PASSWORD}"]
        environment:
            REDIS_PASSWORD: ${REDIS_PASSWORD}
        volumes:
            - redis-data:/data

volumes:
    mongo-data:
    cassandra-data:
    postgres-data:
    redis-data:
